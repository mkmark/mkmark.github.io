<!DOCTYPE html><html><head><meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="light dark"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-175297541-1"></script><title>Polylang no-translation Redirection</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="/content/css/styles.css?v=202204172000"><script src="/content/js/header.js?v=202102080708"></script><link rel="alternate" href="/atom.xml" title="Mark Ma's Blog" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Mark Ma's Blog" type="application/rss+xml"></head><body onclick=""><div class="sidebar" id="sidebar" onclick=""><div class="sidebar-item"><h1 style="margin-top:1.6em">Mark Ma&#39;s Blog</h1></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="/">About</a> <a class="sidebar-nav-item" href="/blog/">Blog</a> <a class="sidebar-nav-item" href="/archive/by-date/">　by Date</a> <a class="sidebar-nav-item" href="/archive/by-category/">　by Category</a> <a class="sidebar-nav-item" href="/archive/by-tag/">　by Tag</a> <a class="sidebar-nav-item" href="/portfolio/">Portfolio</a> <a class="sidebar-nav-item" href="/archive/by-tag/civil-engineering/">　Civil Engineering</a> <a class="sidebar-nav-item" href="/portfolio/graphic-design/">　Graphic Design</a> <a class="sidebar-nav-item" href="/portfolio/video-composition/">　Video Composition</a> <a class="sidebar-nav-item" href="/portfolio/web-design/">　Web Design</a><div class="sidebar-nav-item" onclick="switchColorMode()" style="cursor:pointer">Dark Mode</div></nav><div class="sidebar-item" style="font-size:.85em"><p><a href="/privacy-policy/">Privacy Policy</a></p><p>&copy; 2017-2022. All rights reserved.</p></div></div><div class="markdown-body"><article id="post-md/2018-10-19-polylang-no-translation-redirection" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Polylang no-translation Redirection</h1></header><p class="post-meta"><time class="dt-published" datetime="2018-10-19T05:03:00+00:00" itemprop="datePublished">2018-10-19</time></p><div class="e-content article-entry" itemprop="articleBody"><p>Polylang redirects to home page when it's not able find a translation for current page. Following code will enable it to stay on the same page but still to update the language cookie.</p><a id="more"></a><h3 id="Refresh-instead-of-Redirection">Refresh instead of Redirection</h3><h4 id="Path">Path</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./plugins/polylang/include/switcher.php</code></pre><h4 id="Original-Code">Original Code</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$url</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'force_home'</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token variable">$links</span><span class="token operator">-></span><span class="token function">get_home_url</span><span class="token punctuation">(</span> <span class="token variable">$language</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$url</span><span class="token punctuation">;</span> <span class="token comment">// If the page is not translated, link to the home page</span></code></pre><h4 id="Replace-with">Replace with</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'force_home'</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token variable">$links</span><span class="token operator">-></span><span class="token function">get_home_url</span><span class="token punctuation">(</span> <span class="token variable">$language</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$url</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$url</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token variable">$terminal_url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://'</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$terminal_url</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><h3 id="Force-updating-cookie">Force updating cookie</h3><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"no-translation"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"no-translation"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstElementChild<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span>update_language_cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">update_language_cookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"no-translation"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstElementChild<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">'zh-CN'</span><span class="token operator">:</span>
            <span class="token function">writeCookie</span><span class="token punctuation">(</span><span class="token string">'zh'</span><span class="token punctuation">,</span> <span class="token string">'pll_language'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'en-US'</span><span class="token operator">:</span>
            <span class="token function">writeCookie</span><span class="token punctuation">(</span><span class="token string">'en'</span><span class="token punctuation">,</span> <span class="token string">'pll_language'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">writeCookie</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> name<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> Days <span class="token operator">=</span> <span class="token number">365</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> exp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exp<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Days <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";expires="</span> <span class="token operator">+</span> exp<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">";path=/"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> nameValue <span class="token operator">=</span> <span class="token function">getCookie</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nameValue <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";expires="</span> <span class="token operator">+</span> exp<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";path=/"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> keyValue <span class="token operator">=</span> <span class="token function">getCookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>keyValue <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                nameValue <span class="token operator">=</span> nameValue<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> keyValue<span class="token punctuation">,</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span><span class="token function">encodeURI</span> <span class="token punctuation">(</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> nameValue <span class="token operator">+</span> <span class="token string">";expires="</span> <span class="token operator">+</span> exp<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";path=/"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> 
                document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> nameValue <span class="token operator">+</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";expires="</span> <span class="token operator">+</span> exp<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">";path=/"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><h3 id="Force-delete-translation-designation">Force delete translation designation</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># find designation</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">`</span>object_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>wp_term_relationships<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>term_taxonomy_id<span class="token punctuation">`</span> 
<span class="token keyword">INTO</span> <span class="token variable">@object_id</span><span class="token punctuation">,</span> <span class="token variable">@term_taxonomy_id</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">`</span>wp_term_taxonomy<span class="token punctuation">`</span> 
	<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>wp_term_relationships<span class="token punctuation">`</span> 
<span class="token keyword">ON</span> <span class="token punctuation">`</span>wp_term_taxonomy<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>term_taxonomy_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>wp_term_relationships<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>term_taxonomy_id<span class="token punctuation">`</span> 
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>taxonomy<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'language'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">`</span>object_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment"># delete designation</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>wp_term_relationships<span class="token punctuation">`</span> 
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>object_id<span class="token punctuation">`</span><span class="token operator">=</span><span class="token variable">@object_id</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">`</span>term_taxonomy_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token variable">@term_taxonomy_id</span><span class="token punctuation">;</span>
<span class="token comment"># update language page count</span>
<span class="token keyword">UPDATE</span> <span class="token punctuation">`</span>wp_term_taxonomy<span class="token punctuation">`</span> <span class="token keyword">SET</span> <span class="token punctuation">`</span>count<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>count<span class="token punctuation">`</span><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>term_taxonomy_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token variable">@term_taxonomy_id</span><span class="token punctuation">;</span></code></pre><h3 id="Query-All-Languages">Query All Languages</h3><h4 id="functions-php">functions.php</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">/*====== Altering the main query with query_posts() ======*/</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pre_get_posts'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'alter_query'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">alter_query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//gets the global query var object</span>
	<span class="token keyword">global</span> <span class="token variable">$wp_query</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token variable">$query</span><span class="token operator">-></span><span class="token function">is_main_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token variable">$query</span><span class="token operator">-></span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tax_query'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><h3 id="Reference">Reference</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/EncryptingLife/p/3952372.html" title="js 操作cookie cookie路径问题">js 操作cookie cookie路径问题</a><br><a target="_blank" rel="noopener" href="https://presscustomizr.com/snippet/three-techniques-to-alter-the-query-in-wordpress/" title="Three techniques to alter the query in WordPress">Three techniques to alter the query in WordPress</a></p><h3 id="License">License</h3><p>Polylang is licensed under GPL V2 + or GPL V3+ licence, so is my work. See <a target="_blank" rel="noopener" href="https://polylang.pro/terms/" title="https://polylang.pro/terms/">https://polylang.pro/terms/</a>.<br><a target="_blank" rel="noopener" href="https://github.com/polylang/polylang/blob/master/LICENSE"><img src="https://img.shields.io/github/license/polylang/polylang.svg" alt="GitHub license"></a></p></div></div></article></div><div id="privacy-notice"><div id="privacy-notice-content" class="markdown-body"><div><a id="privacy-notice-dismiss" class="btn"><svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor;vertical-align:baseline;margin-top:-.3em;margin-bottom:-.3em"><path d="M15 4.41L13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z"/></svg></a></div><div>Hover your mouse or tap on the left edge to navigate.<br>Upon dismissing, you acknowledge that you have read and understand our <a href="/privacy-policy/">Privacy Policy</a>.</div></div></div></body><footer><script src="/content/js/footer.js?v=202102080708"></script></footer></html>