<!DOCTYPE html><html><head><meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="light dark"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-175297541-1"></script><title>TL-R473G Router Hack</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="/content/css/styles.css?v=202102162213"><script src="/content/js/header.js?v=202102080708"></script><link rel="alternate" href="/atom.xml" title="Mark Ma's Blog" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Mark Ma's Blog" type="application/rss+xml"></head><body onclick=""><div class="sidebar" id="sidebar" onclick=""><div class="sidebar-item"><h1 style="margin-top:1.6em">Mark Ma&#39;s Blog</h1></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="/">About</a> <a class="sidebar-nav-item" href="/blog/">Blog</a> <a class="sidebar-nav-item" href="/archive/by-date/">　by Date</a> <a class="sidebar-nav-item" href="/archive/by-category/">　by Category</a> <a class="sidebar-nav-item" href="/archive/by-tag/">　by Tag</a> <a class="sidebar-nav-item" href="/portfolio/">Portfolio</a> <a class="sidebar-nav-item" href="/archive/by-tag/civil-engineering/">　Civil Engineering</a> <a class="sidebar-nav-item" href="/portfolio/graphic-design/">　Graphic Design</a> <a class="sidebar-nav-item" href="/portfolio/video-composition/">　Video Composition</a> <a class="sidebar-nav-item" href="/portfolio/web-design/">　Web Design</a><div class="sidebar-nav-item" onclick="switchColorMode()" style="cursor:pointer">Dark Mode</div></nav><div class="sidebar-item"><p><a href="/privacy-policy/" style="font-size:.85em">Privacy Policy</a></p><p>&copy; 2017-2021. All rights reserved.</p></div></div><div class="markdown-body"><article id="post-md/2021-02-23-tl-r473g-router-hack" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">TL-R473G Router Hack</h1></header><p class="post-meta"><time class="dt-published" datetime="2021-02-23T02:53:00+00:00" itemprop="datePublished">2021-02-23</time></p><div class="e-content article-entry" itemprop="articleBody"><p>I finally come back home to reset the router which was accidentally turned into brick half an year ago. With more experience in Linux I finally successfully gained root access to the device.</p><a id="more"></a><h2 id="Purpose">Purpose</h2><p>The intention was to fully utilize the router so that I can use it as a bridge, allowing me to access China LAN and home LAN from abroad using reverse proxy for NAT traversal. This however, failed in a sense of practical use due to various reasons.</p><ul><li>TL-R473G is not a openly supported OpenWRT router, despite the official rom is built on OpenWRT 14.07, there is no way to upgrade it</li><li>The corresponding SDk <a target="_blank" rel="noopener" href="https://archive.openwrt.org/barrier_breaker/14.07/ar71xx/generic/OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2">OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2</a> was too old to support various modules. To safely cross the GFW there isn't much choice, i.e. V2ray requires golang which is yet included in the SDK snapshot</li><li>The latest SDK <a target="_blank" rel="noopener" href="https://downloads.openwrt.org/snapshots/targets/ath79/generic/openwrt-sdk-ath79-generic_gcc-8.4.0_musl.Linux-x86_64.tar.xz">openwrt-sdk-ath79-generic_gcc-8.4.0_musl.Linux-x86_64</a> despite supports golang, uses a different C lib (may have other critical differences too) and is not intended to compile for an older system</li></ul><p>Still, the successful root itself is a breakthrough.</p><h2 id="Minimal-root-Workflow">Minimal root Workflow</h2><p>Back up the router config <code>backup-TP-LINK-xxxx-xx-xx.bin</code></p><p>Rename to <code>backup-TP-LINK-xxxx-xx-xx.bin.tar.gz</code></p><p>Use 7z to modify <code>tmp/userconfig/etc/config/dropbear</code>, change <code>option ssh_port_switch</code> form <code>off</code> to <code>on</code></p><p>Restore using the modified backup.</p><p>Get the routers LAN MAC address (can be found in the web console)</p><p>Get the root password by</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"<span class="token variable">$macAddr</span>"</span> <span class="token operator">|</span> md5sum<span class="token variable">)</span></span>
<span class="token builtin class-name">echo</span> <span class="token variable">$&#123;key<span class="token operator">:</span>0<span class="token operator">:</span>8&#125;</span></code></pre><p>where <code>$macAddr</code> is the MAC address.</p><p>ssh into the router using</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">ssh</span> root@192.168.1.1 -p <span class="token number">33400</span></code></pre><h2 id="The-Exploit">The Exploit</h2><p>The official rom has a web interface which allows backup and restore using generated <code>backup-TP-LINK-xxxx-xx-xx.bin</code> file, which turns out to be a <code>tar.gz</code> file of various config files, including <code>/etc/passwd</code>, <code>/etc/shadow</code>, and <code>/etc/config/dropbear</code></p><p>By modifying the backup file and restore, we can modify the system files.</p><p>To enable ssh login, modify <code>/etc/config/dropbear</code>.</p><p>Changing root password inside <code>/etc/passwd</code> has no effect, which turned out that dropbear is creating root password using <code>/etc/init.d/dropbear/</code></p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function-name function">getNewPasswd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">.</span> /lib/functions.sh
        <span class="token builtin class-name">local</span> <span class="token assign-left variable">macAddr</span><span class="token operator">=</span><span class="token string">""</span>
        <span class="token assign-left variable">macAddr</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>uci_get tddp macaddr macaddr<span class="token variable">)</span></span>
        <span class="token comment">#echo "macAddr is $macAddr" > /dev/console</span>

        <span class="token builtin class-name">local</span> <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"<span class="token variable">$macAddr</span>"</span> <span class="token operator">|</span> md5sum<span class="token variable">)</span></span>
        <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>key:0:8<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
        <span class="token comment">#echo "key is $key" > /dev/console</span>

        <span class="token builtin class-name">echo</span> <span class="token variable">$&#123;key&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>This file is not included in the backup file, but has mod 755, allows access once ssh into the router.</p><p>So we first modify the dropbear config as in minimal root workflow, then create a new user in <code>/etc/passwd</code>, <code>/etc/shadow</code>, ssh into the router using this new user, only to find the <code>/etc/init.d/dropbear/</code> exactly as above, allowing us to acquire the root password as in the minimal root workflow.</p><h2 id="Misc">Misc</h2><pre class="language-none"><code class="language-none">root@TP-LINK:&#x2F;etc# cat &#x2F;etc&#x2F;*release
DISTRIB_ID&#x3D;&quot;OpenWrt&quot;
DISTRIB_RELEASE&#x3D;&quot;Barrier Breaker&quot;
DISTRIB_REVISION&#x3D;&quot;r60685&quot;
DISTRIB_CODENAME&#x3D;&quot;barrier_breaker&quot;
DISTRIB_TARGET&#x3D;&quot;ar71xx&#x2F;generic&quot;
DISTRIB_DESCRIPTION&#x3D;&quot;OpenWrt Barrier Breaker 14.07&quot;
DISTRIB_TAINTS&#x3D;&quot;no-all no-ipv6 busybox&quot;

root@TP-LINK:&#x2F;etc# opkg print-architecture
arch all 1
arch noarch 1
arch ar71xx 10</code></pre><p>The CPU model information is unclear as it's not provided by OEM. A quick search on google returns results showing that it's using a 775Mhz processor, which combined with MIPS gives search results showing that it is most likely using QCA9563, or QCA956X, both are MIPS 74Kc.</p><h3 id="update-opkg">update opkg</h3><p>refer to <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/367292/changing-repository-in-openwrt">opkg - Changing repository in openwrt - Unix &amp; Linux Stack Exchange</a></p><p>but replace <code>https://downloads.openwrt.org</code> with <code>http://archive.openwrt.org</code></p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> /etc/opkg.conf</code></pre><p>add</p><pre class="language-none"><code class="language-none">src&#x2F;gz base https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;base
src&#x2F;gz luci https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;luci
src&#x2F;gz management https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;management
src&#x2F;gz oldpackages https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;oldpackages
src&#x2F;gz packages https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;packages
src&#x2F;gz routing https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;routing
src&#x2F;gz telephony https:&#x2F;&#x2F;archive.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ar71xx&#x2F;generic&#x2F;packages&#x2F;telephony</code></pre><h2 id="Reference">Reference</h2><p><a target="_blank" rel="noopener" href="http://blog.jcat.cn/?p=74">tl-r473gp-ac (tl-r479gp-ac) root 权限 ss + ChinaDNS (shadowsocks + ChinaDNS)</a></p></div></div></article></div><div id="privacy-notice"><div id="privacy-notice-content" class="markdown-body"><div><a id="privacy-notice-dismiss" class="btn"><svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor;vertical-align:baseline;margin-top:-.3em;margin-bottom:-.3em"><path d="M15 4.41L13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z"/></svg></a></div><div>Hover your mouse or tap on the left edge to navigate.<br>Upon dismissing, you acknowledge that you have read and understand our <a href="/privacy-policy/">Privacy Policy</a>.</div></div></div></body><footer><script src="/content/js/footer.js?v=202102080708"></script></footer></html>