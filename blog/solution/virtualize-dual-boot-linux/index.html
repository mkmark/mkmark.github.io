<!DOCTYPE html><html><head><meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="light dark"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-175297541-1"></script><title>Virtualize Dual-boot Linux</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="/content/css/styles.css?v=202102080807"><script src="/content/js/header.js?v=202102080708"></script><link rel="alternate" href="/atom.xml" title="Mark Ma's Blog" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Mark Ma's Blog" type="application/rss+xml"></head><body onclick=""><div class="sidebar" id="sidebar" onclick=""><div class="sidebar-item"><h1 style="margin-top:1.6em">Mark Ma&#39;s Blog</h1></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="/">About</a> <a class="sidebar-nav-item" href="/blog/">Blog</a> <a class="sidebar-nav-item" href="/archive/by-date/">- by Date</a> <a class="sidebar-nav-item" href="/archive/by-category/">- by Category</a> <a class="sidebar-nav-item" href="/archive/by-tag/">- by Tag</a> <a class="sidebar-nav-item" href="/portfolio/">Portfolio</a> <a class="sidebar-nav-item" href="/portfolio/graphic-design/">- Graphic Design</a> <a class="sidebar-nav-item" href="/portfolio/video-composition/">- Video Composition</a> <a class="sidebar-nav-item" href="/portfolio/web-design/">- Web Design</a><div class="sidebar-nav-item" onclick="switchColorMode()" style="cursor:pointer">Dark Mode</div></nav><div class="sidebar-item"><p><a href="/privacy-policy/" style="color:#888;font-size:.85em">Privacy Policy</a></p><p>&copy; 2017-2021. All rights reserved.</p></div></div><div class="markdown-body"><article id="post-md/2021-01-17-virtualize-dual-boot-linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">Virtualize Dual-boot Linux</h1></header><p class="post-meta"><time class="dt-published" datetime="2021-01-17T00:42:00+08:00" itemprop="datePublished">2021-01-17</time></p><div class="e-content article-entry" itemprop="articleBody"><h2 id="Comparing-with-WSL2">Comparing with WSL2</h2><ul><li>Pro<ul><li>Allow maximum performance when using physical machine</li><li>Have Native GUI which can be accessed using VirtualBox</li><li>Native disk operation performance under virtual machine</li></ul></li><li>Con<ul><li>No app optimization and support in Windows, e.g. vscode, cuda (but vscode has ssh featrue, and you have native linux cuda under physical machine)</li><li>Mapped file in RAM is not managed by Windows, naturally, thus requiring a larger RAM (Your RAM stores mapped files from both host Windows and VM Linux now)</li></ul></li><li>Even<ul><li>Other performance under windows, e.g disk operation across systems (using SMB)</li></ul></li></ul><a id="more"></a><h2 id="Install-Linux-on-a-partition">Install Linux on a partition</h2><p>In my case I installed it on sda6, with swap on sda8. These info are later used in .vmdk creation.</p><h2 id="Optional-default-to-CLI">Optional: default to CLI</h2><p>in <code>/etc/default/grub</code></p><p>comment out</p><pre class="language-none"><code class="language-none">GRUB_CMDLINE_LINUX_DEFAULT&#x3D;&quot;quiet splash&quot;</code></pre><p>add</p><pre class="language-none"><code class="language-none">&#96;GRUB_CMDLINE_LINUX_DEFAULT&#x3D;&quot;text&quot;&#96;
&#96;GRUB_GFXPAYLOAD_LINUX&#x3D;keep&#96;</code></pre><p>run</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl set-default multi-user.target
<span class="token function">sudo</span> <span class="token function">update-grub</span></code></pre><p>to launch GUI from CLI</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start graphical.target</code></pre><h2 id="Prepare-ISO-bootimage">Prepare ISO bootimage</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token function">mkdir</span> iso
<span class="token function">mkdir</span> iso/boot
<span class="token function">mkdir</span> iso/boot/grub
<span class="token function">cp</span> /usr/lib/grub/i386-pc/* ~/iso/boot/grub
<span class="token function">cp</span> /boot/grub/grub.cfg ~/iso/boot/grub
grub-mkrescue -o multi-user.iso ~/iso/
<span class="token function">rm</span> -r ~/iso/</code></pre><p>Copy the .iso file into Windows and then reboot into Windows.</p><h2 id="Create-VirtualBox-rawdisk">Create VirtualBox rawdisk</h2><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token punctuation">.</span>\VBoxManage<span class="token punctuation">.</span>exe internalcommands createrawvmdk <span class="token operator">-</span>filename <span class="token string">"C:\Users\Mark\VirtualBox VMs\Ubuntu\Ubuntu.vmdk"</span> <span class="token operator">-</span>rawdisk \\<span class="token punctuation">.</span>\PhysicalDrive0  <span class="token operator">-</span>partitions 6<span class="token punctuation">,</span>8</code></pre><p>see reference for more info.</p><p>Create the VM using the generated .vmdk file and .iso file.</p><p>Warning： misconfiguration of partition would cause severe outcome, i.e. Windows and VM Linux writing to the same partition at the same time, causing data corruption.</p><h2 id="Misc">Misc</h2><h3 id="Auto-mount">Auto mount</h3><p>edit <code>/etc/fstab</code></p><p>add <code>nofail</code> option to EFI partition since it is not available in the .vmdk and would cause a 90 sec stall during boot.</p><p>add windows drive in the following manner</p><pre class="language-none"><code class="language-none">UUID&#x3D;FC90EE0790EDC86A &#x2F;mnt&#x2F;C ntfs rw,auto,nofail,users,exec,nls&#x3D;utf8,umask&#x3D;0000,gid&#x3D;0,uid&#x3D;0,ver&#x3D;3.0            0   0
UUID&#x3D;62ACB2C8ACB2964F &#x2F;mnt&#x2F;D ntfs rw,auto,nofail,users,exec,nls&#x3D;utf8,umask&#x3D;0000,gid&#x3D;0,uid&#x3D;0,ver&#x3D;3.0            0   0
&#x2F;&#x2F;MK-P650RE6-W&#x2F;C      &#x2F;mnt&#x2F;c cifs rw,auto,nofail,users,exec,iocharset&#x3D;utf8,uid&#x3D;0,gid&#x3D;0,file_mode&#x3D;0777,dir_mode&#x3D;0777,credentials&#x3D;&#x2F;root&#x2F;smbcredential,vers&#x3D;3.0,noperm   0   0
&#x2F;&#x2F;MK-P650RE6-W&#x2F;D      &#x2F;mnt&#x2F;d cifs rw,auto,nofail,users,exec,iocharset&#x3D;utf8,uid&#x3D;0,gid&#x3D;0,file_mode&#x3D;0777,dir_mode&#x3D;0777,credentials&#x3D;&#x2F;root&#x2F;smbcredential,vers&#x3D;3.0,noperm   0   0</code></pre><p>so that the NTFS partition can be auto mounted both in physical and virtual machine.</p><p>Note: CIFS allow case-insensitive workflow in Linux, but NTFS are not allowed. Typical issue would arise when, for instance, a .m3u playlist being played with no issue using CIFS, but not when using NTFS, depite being the same disk.</p><h3 id="Auto-path">Auto path</h3><p>Note that the NTFS drives, especially when using the VM, are mounted following the WSL convention, which is done by purpose (but not necessary). With such convention, a typical Windows Terminal Profile can be</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"guid"</span><span class="token operator">:</span> <span class="token string">"&#123;2b20defa-6769-4e3a-a793-d3da106465b8&#125;"</span><span class="token punctuation">,</span>
    <span class="token property">"hidden"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Ubuntu"</span><span class="token punctuation">,</span>
    <span class="token comment">//"commandline": "ssh mark@MK-P650RE6-U",</span>
    <span class="token property">"commandline"</span><span class="token operator">:</span> <span class="token string">"cmd /S /V /K \"ECHO OFF &amp;&amp; FOR /F \"tokens=* USEBACKQ\" %F IN (`cd`) DO ( SET ntpath=%F) &amp; SET driveLetter=!ntpath:~0,1! &amp; FOR /f \"usebackq delims=\" %I in (`powershell \"\\\"!driveLetter!\\\".toLower()\"`) do set \"loweredDriveLetter=%~I\" &amp; SET latterHalf=!ntpath:~2! &amp; SET posixLatterHalf=!latterHalf:\\=/! &amp; SET posixpath=^'/mnt/!loweredDriveLetter:~0,-1!!posixLatterHalf:~0,-2!^' &amp; ssh mark@MK-P650RE6-U -t \"cd !posixpath!; exec $SHELL -l\"\""</span><span class="token punctuation">,</span>
    <span class="token property">"colorScheme"</span> <span class="token operator">:</span> <span class="token string">"One Half Dark"</span><span class="token punctuation">,</span>
    <span class="token property">"useAcrylic"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"acrylicOpacity"</span><span class="token operator">:</span><span class="token number">0.8</span><span class="token punctuation">,</span>
    <span class="token property">"fontFace"</span><span class="token operator">:</span> <span class="token string">"UbuntuMono NF"</span><span class="token punctuation">,</span>
    <span class="token property">"icon"</span><span class="token operator">:</span> <span class="token string">"D:\\Users\\Mark\\Pictures\\Mark\\Data\\icon\\Ubuntu\\Ubuntu-Icon-01-16x16.png"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></code></pre><p>where the host name is <code>MK-P650RE6-U</code> for the Linux system. In LAN, ip is required instead of name. Note that the <code>commandline</code> argument is a batch script wrapped in <code>cmd /S /V /K &quot;&quot;</code> and then escaped according to .json string format, which is essentially as following:</p><pre class="language-batch" data-language="batch"><code class="language-batch"><span class="token command"><span class="token keyword">ECHO</span> OFF</span>
<span class="token command"><span class="token keyword">FOR</span> <span class="token parameter attr-name">/F</span> <span class="token string">"tokens=* USEBACKQ"</span> <span class="token variable">%F</span> <span class="token keyword">IN</span> <span class="token punctuation">(</span>`cd`<span class="token punctuation">)</span> <span class="token keyword">DO</span></span> <span class="token punctuation">(</span> <span class="token command"><span class="token keyword">SET</span> <span class="token variable">ntpath</span><span class="token operator">=</span><span class="token variable">%F</span></span><span class="token punctuation">)</span>
<span class="token command"><span class="token keyword">SET</span> <span class="token variable">driveLetter</span><span class="token operator">=</span><span class="token variable">!ntpath:~0,1!</span></span>
<span class="token command"><span class="token keyword">FOR</span> <span class="token parameter attr-name">/f</span> <span class="token string">"usebackq delims="</span> <span class="token variable">%I</span> in (`powershell <span class="token string">"\"!driveLetter!\".toLower()"</span>`</span><span class="token punctuation">)</span> do set "loweredDriveLetter=%~I"
<span class="token command"><span class="token keyword">SET</span> <span class="token variable">latterHalf</span><span class="token operator">=</span><span class="token variable">!ntpath:~2!</span></span>
<span class="token command"><span class="token keyword">SET</span> <span class="token variable">posixLatterHalf</span><span class="token operator">=</span><span class="token variable">!latterHalf:\=/!</span></span>
<span class="token command"><span class="token keyword">SET</span> <span class="token variable">posixpath</span><span class="token operator">=</span><span class="token operator">^</span><span class="token punctuation">'</span><span class="token operator">/</span>mnt<span class="token operator">/</span><span class="token variable">!loweredDriveLetter:~0,-1!!posixLatterHalf:~0,-2!</span><span class="token operator">^</span><span class="token punctuation">'</span></span>
<span class="token command"><span class="token keyword">ssh</span> mark@MK-P650RE6<span class="token parameter attr-name">-U</span> <span class="token parameter attr-name">-t</span> <span class="token string">"cd !posixpath!; exec $SHELL -l"</span></span></code></pre><p>which extracts Windows path, converts into Linux path, then launches ssh and cd into it.</p><h3 id="Auto-launch">Auto launch</h3><p>Add in Task Scheduler</p><pre class="language-batch" data-language="batch"><code class="language-batch">"C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" startvm Ubuntu --type headless</code></pre><h2 id="Reference">Reference</h2><p><a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch09.html#rawdisk" title="Chapter 9. Advanced Topics">Chapter 9. Advanced Topics</a></p><p><a target="_blank" rel="noopener" href="https://lifehacker.com/how-to-dual-boot-and-virtualize-the-same-partition-on-y-493223329" title="How to Dual Boot and Virtualize the Same Partition on Your Computer">How to Dual Boot and Virtualize the Same Partition on Your Computer</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/626533/how-can-i-ssh-directly-to-a-particular-directory/626574#626574" title="bash - How can I ssh directly to a particular directory? - Stack Overflow">bash - How can I ssh directly to a particular directory? - Stack Overflow</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6359820/how-to-set-commands-output-as-a-variable-in-a-batch-file/6362922#6362922" title="windows - How to set commands output as a variable in a batch file - Stack Overflow">windows - How to set commands output as a variable in a batch file - Stack Overflow</a></p><p><a target="_blank" rel="noopener" href="https://ss64.com/nt/syntax-substring.html" title="variable substring - Windows CMD - SS64.com">variable substring - Windows CMD - SS64.com</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34713621/batch-converting-variable-to-uppercase/34723215#34723215" title="cmd - Batch - Converting variable to uppercase - Stack Overflow">cmd - Batch - Converting variable to uppercase - Stack Overflow</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20339341/why-can-i-not-get-a-substring-of-a-delayed-expansion-variable-in-an-if-statement/20342275#20342275" title="batch file - Why can I not get a substring of a delayed expansion variable in an if statement? - Stack Overflow">batch file - Why can I not get a substring of a delayed expansion variable in an if statement? - Stack Overflow</a></p></div></div></article></div><div id="privacy-notice"><div id="privacy-notice-content" class="markdown-body"><div><a id="privacy-notice-dismiss" class="btn"><svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor;vertical-align:baseline;margin-top:-.3em;margin-bottom:-.3em"><path d="M15 4.41L13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z"/></svg></a></div><div>Hover your mouse or tap on the left edge to navigate.<br>Upon dismissing, you acknowledge that you have read and understand our <a href="/privacy-policy/">Privacy Policy</a>.</div></div></div></body><footer><script src="/content/js/footer.js?v=202102080708"></script></footer></html>