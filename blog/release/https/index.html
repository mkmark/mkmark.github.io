<!DOCTYPE html><html><head><meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="light dark"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-175297541-1"></script><title>HTTPS!</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="/content/css/styles.css?v=202102162213"><script src="/content/js/header.js?v=202102080708"></script><link rel="alternate" href="/atom.xml" title="Mark Ma's Blog" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Mark Ma's Blog" type="application/rss+xml"></head><body onclick=""><div class="sidebar" id="sidebar" onclick=""><div class="sidebar-item"><h1 style="margin-top:1.6em">Mark Ma&#39;s Blog</h1></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="/">About</a> <a class="sidebar-nav-item" href="/blog/">Blog</a> <a class="sidebar-nav-item" href="/archive/by-date/">　by Date</a> <a class="sidebar-nav-item" href="/archive/by-category/">　by Category</a> <a class="sidebar-nav-item" href="/archive/by-tag/">　by Tag</a> <a class="sidebar-nav-item" href="/portfolio/">Portfolio</a> <a class="sidebar-nav-item" href="/archive/by-tag/civil-engineering/">　Civil Engineering</a> <a class="sidebar-nav-item" href="/portfolio/graphic-design/">　Graphic Design</a> <a class="sidebar-nav-item" href="/portfolio/video-composition/">　Video Composition</a> <a class="sidebar-nav-item" href="/portfolio/web-design/">　Web Design</a><div class="sidebar-nav-item" onclick="switchColorMode()" style="cursor:pointer">Dark Mode</div></nav><div class="sidebar-item" style="font-size:.85em"><p><a href="/privacy-policy/">Privacy Policy</a></p><p>&copy; 2017-2022. All rights reserved.</p></div></div><div class="markdown-body"><article id="post-md/2018-07-27-https!" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">HTTPS!</h1></header><p class="post-meta"><time class="dt-published" datetime="2018-07-27T17:14:00+00:00" itemprop="datePublished">2018-07-27</time></p><div class="e-content article-entry" itemprop="articleBody"><p>After being continuously locked up by GFW for a whole week I decide to change my site into a real https site.<br>Given the fact that I can only use port 80 and 443 for all the activities across GFW, I have to make port 443 for both nginx and ShadowsocksR (for scurity reason).<br>Thus, ssr will divide the inbound packages into two parts, one for itself and another redirected to port xxx for nginx, as following.</p><a id="more"></a><h3 id="Installing-Certificate">Installing Certificate</h3><p>A common HTTP challenge features automatic renew.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://dl.eff.org/certbot-auto
<span class="token function">chmod</span> a+x certbot-auto
certbot certonly --webroot -w /var/www/example -d www.example1.com -d www.example2.com</code></pre><p>A wildcard installation allows batch installing, but the install and renew requires manual update of DNS records, i.e. through DNS challenge.</p><pre class="language-bash" data-language="bash"><code class="language-bash">certbot certonly --manual --cert-name example.com -d example.com -d <span class="token string">"*.example.com"</span> --preferred-challenges<span class="token operator">=</span>dns</code></pre><h3 id="wp-config-php">wp-config.php</h3><pre class="language-php" data-language="php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WP_HOME'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'https://www.mkmark.net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WP_SITEURL'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'https://www.mkmark.net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="Nginx-nginx-conf">Nginx - nginx.conf</h3><pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token comment">#listen [::]:80 default_server ipv6only=on;</span>

        <span class="token keyword">server_name</span> www<span class="token punctuation">.</span>mkmark<span class="token punctuation">.</span>net<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">server</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">listen</span> xxx<span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> www<span class="token punctuation">.</span>mkmark<span class="token punctuation">.</span>net<span class="token punctuation">;</span>
         
        <span class="token keyword">ssl</span>                  on<span class="token punctuation">;</span>   
        <span class="token keyword">ssl_certificate</span>      <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>    
        <span class="token keyword">ssl_certificate_key</span>  <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>  
        <span class="token keyword">ssl_protocols</span> TLSv1 TLSv1<span class="token punctuation">.</span><span class="token number">1</span> TLSv1<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">;</span></code></pre><h3 id="ShadowsocksR-user-config-json">ShadowsocksR - user-config.json</h3><pre class="language-json" data-language="json"><code class="language-json"><span class="token property">"redirect"</span><span class="token operator">:</span> <span class="token string">":443#127.0.0.1:xxx"</span><span class="token punctuation">,</span></code></pre><h3 id="Cron">Cron</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">crontab</span> -e
i
<span class="token number">0</span> <span class="token number">0,12</span> * * * python -c <span class="token string">'import random; import time; time.sleep(random.random() * 3600)'</span> <span class="token operator">&amp;&amp;</span> ./path/to/certbot-auto renew
<span class="token punctuation">[</span>esc<span class="token punctuation">]</span>
:wq<span class="token operator">!</span></code></pre><h3 id="Reference">Reference</h3><p>https://certbot.eff.org/<br>https://certbot.eff.org/docs/using.html#webroot<br>https://xtboke.cn/jsjc/273.html</p></div></div></article></div><div id="privacy-notice"><div id="privacy-notice-content" class="markdown-body"><div><a id="privacy-notice-dismiss" class="btn"><svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor;vertical-align:baseline;margin-top:-.3em;margin-bottom:-.3em"><path d="M15 4.41L13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z"/></svg></a></div><div>Hover your mouse or tap on the left edge to navigate.<br>Upon dismissing, you acknowledge that you have read and understand our <a href="/privacy-policy/">Privacy Policy</a>.</div></div></div></body><footer><script src="/content/js/footer.js?v=202102080708"></script></footer></html>